<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberThreat Analyzer v10.2</title>
    <!-- تحميل Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- تحميل مكتبة Font Awesome للأيقونات -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- تحميل مكتبة Vis.js للخط الزمني التفاعلي -->
    <script type="text/javascript" src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>
    <link href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
    <style>
        /* خط مخصص للغة العربية */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #0d1117; /* خلفية داكنة */
            color: #c9d1d9; /* نص فاتح */
            direction: rtl;
        }
        .container {
            max-width: 1200px;
        }
        .header-card {
            background-color: #161b22;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .card {
            background-color: #161b22;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
            border: 1px solid #30363d;
        }
        .critical-bg { background-color: #e53e3e; } /* أحمر غامق */
        .high-bg { background-color: #dd6b20; } /* برتقالي */
        .medium-bg { background-color: #d69e2e; } /* أصفر */
        .low-bg { background-color: #38a169; } /* أخضر */

        /* تخصيص زر التحليل */
        .analyze-button {
            background-color: #238636; /* أخضر غيت هاب */
            transition: background-color 0.3s, transform 0.1s;
        }
        .analyze-button:hover {
            background-color: #2ea043;
        }
        .analyze-button:active {
            transform: scale(0.98);
        }
        /* تخصيص أزرار التبويبات */
        .tab-button {
            transition: background-color 0.2s, color 0.2s;
            border: 1px solid transparent;
        }
        .tab-button.active {
            background-color: #30363d;
            border-color: #8b949e;
        }
        /* لتصميم الخط الزمني (Vis.js) */
        .vis-timeline {
            border: 1px solid #30363d !important;
            background-color: #0d1117 !important;
            color: #c9d1d9 !important;
            border-radius: 0.5rem;
        }
        .vis-item {
            background-color: #21262d !important;
            border-color: #58a6ff !important;
            color: #c9d1d9 !important;
            box-shadow: 0 0 5px rgba(88, 166, 255, 0.5);
        }
        .vis-item.vis-selected {
            border-color: #f78166 !important;
            background-color: #30363d !important;
        }
        .vis-label {
            color: #8b949e !important;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="container mx-auto">
        
        <!-- العنوان الرئيسي -->
        <header class="text-center mb-10 header-card p-6 rounded-xl">
            <h1 class="text-4xl font-bold text-blue-400">CyberThreat Analyzer v10.2</h1>
            <p class="text-xl text-gray-400 mt-2">منصة تحليل التهديدات الجنائية الرقمية: الذكاء والأتمتة في خدمتك</p>
        </header>

        <!-- منطقة التحميل والتحليل -->
        <div class="card p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-blue-300">نقطة الإدخال: تحميل بيانات السجل / التكوين</h2>
            <form id="upload-form" class="space-y-4">
                <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 sm:space-x-reverse">
                    <input type="file" id="file-input" name="file" class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-indigo-50 file:text-indigo-700
                        hover:file:bg-indigo-100 cursor-pointer
                    ">
                    <button type="submit" id="analyze-btn" class="analyze-button w-full sm:w-auto px-6 py-2 text-white font-bold rounded-full flex items-center justify-center" disabled>
                        <i class="fas fa-microscope mr-2"></i>
                        <span id="btn-text">بدء التحليل العميق</span>
                        <div id="loading-spinner" class="spinner ml-2 hidden">
                            <i class="fas fa-sync-alt fa-spin"></i>
                        </div>
                    </button>
                </div>
            </form>

            <!-- رسالة الحالة والأخطاء -->
            <div id="status-message" class="mt-4 p-3 rounded-lg text-center font-medium hidden" role="alert"></div>
        </div>

        <!-- منطقة النتائج (مخفية افتراضياً) -->
        <div id="analysis-results" class="space-y-8 hidden">
            
            <!-- ملخص المخاطر وسردية الهجوم -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- ملخص المخاطر -->
                <div class="card p-6 lg:col-span-1">
                    <h3 class="text-xl font-bold mb-4 text-center text-red-400">ملخص المخاطر</h3>
                    <div id="risk-summary" class="text-center p-6 rounded-lg">
                        <p class="text-6xl font-extrabold text-white" id="risk-score">--</p>
                        <p class="text-2xl mt-3 font-semibold text-white" id="risk-level">غير محدد</p>
                    </div>
                </div>

                <!-- سردية الهجوم -->
                <div class="card p-6 lg:col-span-2">
                    <h3 class="text-xl font-bold mb-4 text-blue-300">سردية الهجوم (AI Narrative)</h3>
                    <p id="attack-summary" class="text-gray-300 mb-4"></p>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="p-3 bg-[#21262d] rounded-md">
                            <p class="font-bold text-gray-400">أصل الهجوم المرجح</p>
                            <p id="attack-origin-country" class="text-white"></p>
                        </div>
                        <div class="p-3 bg-[#21262d] rounded-md">
                            <p class="font-bold text-gray-400">نية المهاجم</p>
                            <p id="attacker-intent" class="text-white"></p>
                        </div>
                        <div class="col-span-2 p-3 bg-[#21262d] rounded-md">
                            <p class="font-bold text-gray-400">المراحل المكتشفة</p>
                            <p id="attack-stages" class="text-white text-sm"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- التبويبات الرئيسية للنتائج -->
            <div class="card p-6">
                
                <!-- أزرار التبويبات -->
                <div class="flex overflow-x-auto border-b border-[#30363d] mb-4">
                    <button id="tab-detailed" class="tab-button active px-4 py-2 text-sm font-medium rounded-t-lg">النتائج التفصيلية والمصفوفات</button>
                    <button id="tab-ip" class="tab-button px-4 py-2 text-sm font-medium rounded-t-lg">استخبارات IP وحالة الحياة</button>
                    <button id="tab-rca" class="tab-button px-4 py-2 text-sm font-medium rounded-t-lg">تحليل السبب الجذري (RCA)</button>
                    <button id="tab-yara" class="tab-button px-4 py-2 text-sm font-medium rounded-t-lg">محاكاة YARA المطابقة</button>
                    <button id="tab-timeline" class="tab-button px-4 py-2 text-sm font-medium rounded-t-lg">الخط الزمني التفاعلي</button>
                    <button id="tab-recommendations" class="tab-button px-4 py-2 text-sm font-medium rounded-t-lg">التوصيات والإجراءات المضادة</button>
                </div>

                <!-- محتوى التبويبات -->
                <div id="tab-content">
                    
                    <!-- التبويب 1: النتائج التفصيلية والمصفوفات (افتراضي) -->
                    <div id="content-detailed" class="tab-content">
                        <h4 class="text-xl font-bold mb-4 text-orange-400">النتائج التفصيلية</h4>
                        <div id="detailed-findings-container" class="space-y-6">
                            <!-- سيتم حقن نتائج الـ Critical, High, Medium, Low هنا -->
                        </div>
                    </div>

                    <!-- التبويب 2: استخبارات IP وحالة الحياة -->
                    <div id="content-ip" class="tab-content hidden">
                        <h4 class="text-xl font-bold mb-4 text-green-400">استخبارات IP وحالة الحياة</h4>
                        <p class="text-sm text-gray-400 mb-4">البيانات المتعلقة بعناوين IP الموجودة في السجل وذكاء التهديد المرتبط بها.</p>
                        <div id="ip-intelligence-table">
                            <!-- سيتم حقن جدول استخبارات IP هنا -->
                        </div>
                    </div>

                    <!-- التبويب 3: تحليل السبب الجذري (RCA) -->
                    <div id="content-rca" class="tab-content hidden">
                        <h4 class="text-xl font-bold mb-4 text-purple-400">تحليل السبب الجذري (RCA)</h4>
                        <p class="text-sm text-gray-400 mb-4">تحليل مفصل للأسباب الجذرية للحادث والتوصيات المباشرة.</p>
                        <div id="rca-analysis-table">
                            <!-- سيتم حقن جدول تحليل السبب الجذري هنا -->
                        </div>
                    </div>

                    <!-- التبويب 4: محاكاة YARA المطابقة -->
                    <div id="content-yara" class="tab-content hidden">
                        <h4 class="text-xl font-bold mb-4 text-yellow-400">محاكاة YARA المطابقة</h4>
                        <p class="text-sm text-gray-400 mb-4">محاكاة لنتائج فحص قواعد YARA التي قد تكون مطابقة للمؤشرات في السجل.</p>
                        <div id="yara-analysis-table">
                            <!-- سيتم حقن جدول YARA هنا -->
                        </div>
                    </div>

                    <!-- التبويب 5: الخط الزمني التفاعلي -->
                    <div id="content-timeline" class="tab-content hidden">
                        <h4 class="text-xl font-bold mb-4 text-cyan-400">الخط الزمني التفاعلي</h4>
                        <p class="text-sm text-gray-400 mb-4">عرض مرئي متفاعل لتسلسل الأحداث الأمنية.</p>
                        <div id="timeline-visualization" style="height: 300px; width: 100%;">
                            <!-- سيتم تهيئة خط الزمن Vis.js هنا -->
                        </div>
                    </div>

                    <!-- التبويب 6: التوصيات والإجراءات المضادة -->
                    <div id="content-recommendations" class="tab-content hidden">
                        <h4 class="text-xl font-bold mb-4 text-pink-400">التوصيات والإجراءات المضادة</h4>
                        <ul id="recommendations-list" class="list-disc pr-6 space-y-2 text-gray-300">
                            <!-- سيتم حقن قائمة التوصيات هنا -->
                        </ul>
                    </div>

                </div>
            </div>

            <!-- البيانات الوصفية للتحليل -->
            <div class="text-center text-sm text-gray-500 mt-4">
                <p id="analysis-time-meta"></p>
            </div>
            
        </div>
    </div>

    <!-- كود JavaScript للتعامل مع الواجهة الأمامية والاتصال الخلفي -->
    <script>
        const uploadForm = document.getElementById('upload-form');
        const fileInput = document.getElementById('file-input');
        const analyzeBtn = document.getElementById('analyze-btn');
        const btnText = document.getElementById('btn-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const statusMessage = document.getElementById('status-message');
        const resultsDiv = document.getElementById('analysis-results');

        // عناصر ملخص المخاطر
        const riskSummaryDiv = document.getElementById('risk-summary');
        const riskScoreP = document.getElementById('risk-score');
        const riskLevelP = document.getElementById('risk-level');
        
        // عناصر سردية الهجوم
        const attackSummaryP = document.getElementById('attack-summary');
        const attackOriginCountryP = document.getElementById('attack-origin-country');
        const attackerIntentP = document.getElementById('attacker-intent');
        const attackStagesP = document.getElementById('attack-stages');

        // حاويات الجداول
        const detailedFindingsContainer = document.getElementById('detailed-findings-container');
        const ipIntelligenceTableDiv = document.getElementById('ip-intelligence-table');
        const rcaAnalysisTableDiv = document.getElementById('rca-analysis-table');
        const yaraAnalysisTableDiv = document.getElementById('yara-analysis-table');
        const recommendationsList = document.getElementById('recommendations-list');
        const analysisTimeMetaP = document.getElementById('analysis-time-meta');

        // الخط الزمني
        const timelineVisualizationDiv = document.getElementById('timeline-visualization');
        let timeline = null; // للاحتفاظ بنسخة من خط الزمن

        // ------------------------------------------
        // وظائف مساعدة عامة
        // ------------------------------------------

        /**
         * يعرض رسالة حالة (خطأ أو نجاح) على الواجهة.
         * @param {string} message - نص الرسالة.
         * @param {string} type - نوع الرسالة ('success' أو 'error' أو 'info').
         */
        function displayStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'bg-red-800', 'bg-green-800', 'bg-blue-800', 'text-white');
            
            if (type === 'error') {
                statusMessage.classList.add('bg-red-800', 'text-white');
            } else if (type === 'success') {
                statusMessage.classList.add('bg-green-800', 'text-white');
            } else {
                statusMessage.classList.add('bg-blue-800', 'text-white');
            }
        }

        /**
         * يقوم بتحديث حالة زر التحليل (تمكين/تعطيل + تحميل).
         * @param {boolean} isLoading - هل العملية قيد التحميل.
         */
        function updateButtonState(isLoading) {
            if (isLoading) {
                analyzeBtn.disabled = true;
                loadingSpinner.classList.remove('hidden');
                btnText.textContent = 'جاري التحليل...';
            } else {
                analyzeBtn.disabled = fileInput.files.length === 0;
                loadingSpinner.classList.add('hidden');
                btnText.textContent = 'بدء التحليل العميق';
            }
        }

        // ------------------------------------------
        // وظائف بناء واجهة المستخدم
        // ------------------------------------------

        /**
         * يقوم بإنشاء أيقونة الحالة (حي أو ميت) لجدول IP.
         * @param {string} status - حالة IP ('حي', 'ميت', 'N/A').
         * @returns {string} - كود HTML للأيقونة.
         */
        function renderStatusIcon(status) {
            const normalizedStatus = status.toLowerCase().trim();
            if (normalizedStatus === 'حي') {
                return '<i class="fas fa-circle text-green-500 text-xs ml-1"></i> حي';
            } else if (normalizedStatus === 'ميت') {
                return '<i class="fas fa-circle text-red-500 text-xs ml-1"></i> ميت';
            }
            return status; // إرجاع النص كما هو لـ N/A أو أي حالة أخرى
        }


        /**
         * إنشاء جدول HTML من مصفوفة بيانات.
         * @param {Array<Object>} data - مصفوفة البيانات.
         * @param {Array<string>} headers - رؤوس الجدول بالترتيب.
         * @returns {string} - كود HTML للجدول.
         */
        function createTableHTML(data, headers, isIpTable = false) {
            if (!data || data.length === 0) {
                return '<p class="text-gray-500">لا توجد بيانات متاحة لهذا الجدول في التحليل.</p>';
            }

            let html = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-[#30363d] rounded-lg">';
            
            // رؤوس الجدول
            html += '<thead class="bg-[#21262d]">';
            html += '<tr>';
            headers.forEach(header => {
                html += `<th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">${header}</th>`;
            });
            html += '</tr>';
            html += '</thead>';

            // جسم الجدول
            html += '<tbody class="divide-y divide-[#30363d]">';
            data.forEach((row, index) => {
                const bgColor = index % 2 === 0 ? 'bg-[#161b22]' : 'bg-[#1e2329]'; // تظليل متناوب
                html += `<tr class="${bgColor}">`;
                headers.forEach(headerKey => {
                    let cellContent = row[headerKey] || '';
                    
                    // 🛑🛑🛑 إضافة الأيقونة الملونة لحالة IP 🛑🛑🛑
                    if (isIpTable && headerKey === 'الحالة') {
                        cellContent = renderStatusIcon(cellContent);
                    }

                    html += `<td class="px-4 py-4 whitespace-normal text-sm text-gray-300">${cellContent}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody>';
            html += '</table></div>';
            return html;
        }

        /**
         * إنشاء قسم النتائج التفصيلية (Critical, High, Medium, Low).
         * @param {Object} detailedFindings - النتائج المفصلة.
         */
        function renderDetailedFindings(detailedFindings) {
            detailedFindingsContainer.innerHTML = ''; // تنظيف الحاوية
            
            const severityOrder = ['critical', 'high', 'medium', 'low'];
            const severityMap = {
                critical: { title: 'نتائج حرجة (Critical)', color: 'critical-bg', icon: 'fas fa-skull-crossbones' },
                high: { title: 'نتائج عالية الخطورة (High)', color: 'high-bg', icon: 'fas fa-exclamation-triangle' },
                medium: { title: 'نتائج متوسطة الخطورة (Medium)', color: 'medium-bg', icon: 'fas fa-bell' },
                low: { title: 'نتائج منخفضة الخطورة (Low)', color: 'low-bg', icon: 'fas fa-info-circle' }
            };

            severityOrder.forEach(key => {
                const findings = detailedFindings[key];
                if (findings && Array.isArray(findings) && findings.length > 0) {
                    const meta = severityMap[key];
                    let html = `
                        <div class="border-2 rounded-lg p-4" style="border-color: ${meta.color.split('-')[0] === 'critical' ? '#e53e3e' : meta.color.split('-')[0] === 'high' ? '#dd6b20' : meta.color.split('-')[0] === 'medium' ? '#d69e2e' : '#38a169'}">
                            <h5 class="text-lg font-bold mb-3 flex items-center ${meta.color.split('-')[0] === 'critical' ? 'text-red-400' : meta.color.split('-')[0] === 'high' ? 'text-orange-400' : meta.color.split('-')[0] === 'medium' ? 'text-yellow-400' : 'text-green-400'}">
                                <i class="${meta.icon} ml-2"></i> ${meta.title} (${findings.length})
                            </h5>
                            <div class="space-y-4">
                    `;
                    findings.forEach(finding => {
                        html += `
                            <div class="p-3 bg-[#21262d] rounded-md border-r-4" style="border-color: ${meta.color.split('-')[0] === 'critical' ? '#e53e3e' : meta.color.split('-')[0] === 'high' ? '#dd6b20' : meta.color.split('-')[0] === 'medium' ? '#d69e2e' : '#38a169'}">
                                <p class="font-semibold text-white mb-1"><i class="fas fa-bug ml-1 text-sm"></i> النتيجة: ${finding["النتيجة"]}</p>
                                <p class="text-gray-400 text-sm"><i class="fas fa-shield-alt ml-1 text-sm"></i> التوصية: ${finding["التوصية"]}</p>
                            </div>
                        `;
                    });
                    html += `
                            </div>
                        </div>
                    `;
                    detailedFindingsContainer.innerHTML += html;
                }
            });

            if (detailedFindingsContainer.innerHTML === '') {
                detailedFindingsContainer.innerHTML = '<p class="text-gray-500">لم يتم العثور على نتائج تفصيلية تتطلب تصنيف خطورة.</p>';
            }
        }
        
        /**
         * تهيئة وعرض الخط الزمني التفاعلي.
         * @param {Object} timelineData - بيانات الخط الزمني.
         */
        function renderTimeline(timelineData) {
            // تنظيف أي خط زمني سابق
            if (timeline) {
                timeline.destroy();
            }

            if (!timelineData || !Array.isArray(timelineData.items) || timelineData.items.length === 0) {
                timelineVisualizationDiv.innerHTML = '<p class="text-gray-500 p-4">لا تتوفر بيانات خط زمني تفاعلي في هذا التحليل.</p>';
                return;
            }

            // تحويل البيانات لتناسب Vis.js
            const items = new vis.DataSet(timelineData.items.map(item => ({
                id: item.id,
                content: item.content,
                start: item.start,
                group: item.group,
                type: item.type || 'point', // افتراضي
                style: item.style || 'background-color: #58a6ff; border-color: #58a6ff;'
            })));

            const groups = new vis.DataSet(timelineData.groups.map(group => ({
                id: group.id,
                content: group.content
            })));

            const options = {
                template: function (item) {
                    return `<div class="p-1">${item.content}</div>`;
                },
                orientation: 'top',
                autoResize: true,
                editable: false,
                stack: true,
                zoomMax: 315360000000, // 10 years in ms
                zoomMin: 1000, // 1 second in ms
                // تخصيص الأسلوب ليتوافق مع الخلفية الداكنة
                locale: 'ar',
                multiselect: true,
                clickToUse: true,
                start: items.min('start') ? new Date(items.min('start').start).getTime() - 86400000 : new Date().getTime() - 86400000,
                end: items.max('start') ? new Date(items.max('start').start).getTime() + 86400000 : new Date().getTime() + 86400000,
            };

            timeline = new vis.Timeline(timelineVisualizationDiv, items, groups, options);
            
            // جعل خط الزمن يستجيب لتغييرات حجم الشاشة
            if (window.timelineResizeListener) {
                window.removeEventListener('resize', window.timelineResizeListener);
            }
            window.timelineResizeListener = () => {
                if (timeline) timeline.fit();
            };
            window.addEventListener('resize', window.timelineResizeListener);
        }

        // ------------------------------------------
        // وظيفة معالجة نتائج التحليل
        // ------------------------------------------

        /**
         * يقوم بحقن بيانات التحليل في الواجهة.
         * @param {Object} data - كائن JSON من استجابة API.
         */
        function displayAnalysis(data) {
            resultsDiv.classList.remove('hidden');

            // 1. ملخص المخاطر
            const risk = data.risk_assessment;
            riskScoreP.textContent = risk.score || 'N/A';
            riskLevelP.textContent = risk.level || 'غير محدد';
            
            riskSummaryDiv.className = 'text-center p-6 rounded-lg'; // إعادة تعيين
            const colorClass = risk.color_class ? risk.color_class.toLowerCase() : 'low';
            riskSummaryDiv.classList.add(`${colorClass}-bg`);

            // 2. سردية الهجوم
            const narrative = data.attack_narrative;
            attackSummaryP.textContent = narrative.summary || 'لا توجد سردية متاحة.';
            attackOriginCountryP.textContent = narrative.attack_origin_country || 'غير محدد';
            attackerIntentP.textContent = narrative.attacker_intent || 'غير محدد';
            attackStagesP.textContent = (narrative.stages_found && narrative.stages_found.length > 0) ? narrative.stages_found.join(' 🛡️ ') : 'لم يتم تحديد مراحل هجوم واضحة.';
            
            // 3. الجداول (الجزء الذي طلبته التعديل فيه)
            const tables = data.tables;
            
            // 3.1. استخبارات IP (إعادة بناء الجدول مع الأيقونات الملونة)
            if (tables.ip_intelligence) {
                const ipHeaders = ["عنوان IP", "المنظمة", "الدولة", "الدور", "الحالة"];
                ipIntelligenceTableDiv.innerHTML = createTableHTML(tables.ip_intelligence, ipHeaders, true); // 🛑🛑🛑 true لتفعيل الأيقونات 🛑🛑🛑
            }

            // 3.2. تحليل السبب الجذري (RCA)
            if (tables.rca_analysis) {
                const rcaHeaders = ["عنصر التحليل", "النتيجة/التفاصيل", "التوصية"];
                rcaAnalysisTableDiv.innerHTML = createTableHTML(tables.rca_analysis, rcaHeaders);
            }

            // 3.3. محاكاة YARA
            if (tables.yara_analysis) {
                const yaraHeaders = ["القاعدة المطابقة", "الشدة", "النتيجة"];
                yaraAnalysisTableDiv.innerHTML = createTableHTML(tables.yara_analysis, yaraHeaders);
            }
            
            // 4. النتائج التفصيلية
            if (data.detailed_findings) {
                renderDetailedFindings(data.detailed_findings);
            }

            // 5. التوصيات
            recommendationsList.innerHTML = '';
            if (data.recommendations && data.recommendations.length > 0) {
                data.recommendations.forEach(rec => {
                    const li = document.createElement('li');
                    li.textContent = rec;
                    recommendationsList.appendChild(li);
                });
            } else {
                recommendationsList.innerHTML = '<p class="text-gray-500">لا توجد توصيات محددة في هذا التحليل.</p>';
            }

            // 6. الخط الزمني التفاعلي
            if (data.interactive_timeline) {
                renderTimeline(data.interactive_timeline);
            }

            // 7. البيانات الوصفية
            analysisTimeMetaP.textContent = `تم الانتهاء من التحليل في: ${data.analysis_metadata.analysis_time || 'وقت غير محدد'}`;
        }
        
        // ------------------------------------------
        // معالجة الأحداث
        // ------------------------------------------

        // تمكين زر التحليل عند اختيار ملف
        fileInput.addEventListener('change', () => {
            analyzeBtn.disabled = fileInput.files.length === 0;
            if (fileInput.files.length > 0) {
                statusMessage.classList.add('hidden');
            }
        });

        // التعامل مع إرسال النموذج (التحليل)
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const file = fileInput.files[0];
            if (!file) {
                displayStatus('الرجاء اختيار ملف سجل للتحليل.', 'info');
                return;
            }

            updateButtonState(true);
            resultsDiv.classList.add('hidden'); // إخفاء النتائج القديمة
            statusMessage.classList.add('hidden');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData,
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.success === false) {
                         // خطأ من API لكن جاء في استجابة 200 (نادر) أو خطأ منطقي آخر
                        displayStatus(data.error || 'حدث خطأ غير معروف في المعالجة.', 'error');
                    } else {
                        // نجاح التحليل
                        displayStatus('✅ اكتمل التحليل بنجاح! يتم عرض النتائج أدناه.', 'success');
                        displayAnalysis(data);
                        // بعد النجاح، ننتقل تلقائياً إلى تبويب النتائج التفصيلية
                        document.getElementById('tab-detailed').click(); 
                    }
                } else {
                    // خطأ من جانب الخادم (4xx أو 5xx)
                    displayStatus(`🚫 خطأ في الخادم (${response.status}): ${data.error || 'فشل الاتصال بالخلفية.'}`, 'error');
                }

            } catch (error) {
                console.error('Fetch Error:', error);
                displayStatus('❌ فشل في الاتصال بالخادم. تأكد من أن الخلفية تعمل بشكل صحيح.', 'error');
            } finally {
                updateButtonState(false);
            }
        });

        // ------------------------------------------
        // إدارة التبويبات (Tabs)
        // ------------------------------------------

        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetId = button.id.replace('tab-', 'content-');

                // إزالة التنشيط من جميع الأزرار وإخفاء جميع المحتويات
                tabButtons.forEach(btn => btn.classList.remove('active', 'bg-[#30363d]', 'border-[#8b949e]'));
                tabContents.forEach(content => content.classList.add('hidden'));

                // تنشيط الزر الحالي وعرض المحتوى المقابل
                button.classList.add('active', 'bg-[#30363d]', 'border-[#8b949e]');
                document.getElementById(targetId).classList.remove('hidden');

                // إعادة احتواء الخط الزمني إذا تم اختياره
                if (targetId === 'content-timeline' && timeline) {
                    // تأخير صغير لضمان اكتمال الرندر
                    setTimeout(() => timeline.fit(), 100); 
                }
            });
        });

        // تمكين زر التحليل عند تحميل الصفحة إذا كان هناك ملف محدد مسبقاً (للتجربة)
        window.addEventListener('load', () => {
             analyzeBtn.disabled = fileInput.files.length === 0;
        });

    </script>
</body>
</html>
